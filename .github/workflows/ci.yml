name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================
  # LINT AND TYPE CHECKING
  # ============================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black mypy pylint
          pip install -r ingestion/requirements.txt
          pip install -r processing/requirements.txt

      - name: Lint with flake8
        run: |
          # Stop on errors, warnings only
          flake8 ingestion/ processing/ query/ scripts/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Full check with configured limits
          flake8 ingestion/ processing/ query/ scripts/ --max-line-length=100 --extend-ignore=E203,W503
        continue-on-error: true

      - name: Check code format with black
        run: |
          black --check ingestion/ processing/ query/ scripts/ --line-length=100
        continue-on-error: true

      - name: Type checking with mypy
        run: |
          mypy ingestion/producer.py \
                processing/streaming_job.py \
                query/percentile_query.py \
                --ignore-missing-imports \
                --show-error-codes
        continue-on-error: true

  # ============================================
  # UNIT TESTS
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-mock
          pip install -r ingestion/requirements.txt
          pip install -r processing/requirements.txt
          pip install -r tests/requirements.txt

      - name: Run unit tests
        env:
          PYTHONPATH: ingestion:processing:query:.
        run: |
          pytest tests/unit/ \
            -v \
            --tb=short \
            --cov=ingestion \
            --cov=processing \
            --cov=query \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

      - name: Archive coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
        if: always()

  # ============================================
  # BUILD AND PUSH DOCKER IMAGES
  # ============================================
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        image:
          - { name: producer, context: ./ingestion }
          - { name: spark, context: ./spark }
          - { name: streaming, context: ./processing }

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.image.name }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.image.context }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # INTEGRATION TESTS (Docker Compose)
  # ============================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start Docker Compose services (Kafka & MinIO)
        run: |
          docker compose up -d kafka minio producer spark-master spark-worker
          sleep 30
          docker compose logs producer

      - name: Install test deps inside producer container
        run: |
          docker compose exec -T producer bash -lc "
            python -m pip install --upgrade pip && \
            python -m pip install -r /app/tests/requirements.txt --no-cache-dir
          "

      - name: Run integration tests in Docker
        run: |
          docker compose exec -T producer bash -c "
            KAFKA_BROKERS=kafka:29092 \
            PYTHONPATH=/app/ingestion:/app/processing:/app/query:/app \
            pytest /app/tests/integration/ \
              -v \
              --tb=short \
              --timeout=300
          "

      - name: Collect logs on failure
        if: failure()
        run: |
          docker compose logs > integration-test-logs.txt

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: integration-test-logs.txt

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v

  # ============================================
  # E2E TESTS (Full Stack)
  # ============================================

  # removed for time being to speed up CI runs

  # e2e-tests:
  #  name: E2E Tests
  #  runs-on: ubuntu-latest
  #  needs: [lint, unit-tests]
  #  timeout-minutes: 60

  #  steps:
  #    - uses: actions/checkout@v4

  #    - name: Set up Docker Buildx
  #      uses: docker/setup-buildx-action@v3

  #    - name: Start full Docker Compose stack
  #      run: |
  #        docker compose up -d kafka kafka-init minio minio-init spark-master spark-worker producer spark-streaming kafka-exporter
  #        sleep 30
  #        docker compose logs producer
  #    
  #    - name: Install test deps inside producer container
  #      run: |
  #        docker compose exec -T producer bash -lc "
  #          python -m pip install --upgrade pip && \
  #          python -m pip install -r /app/tests/requirements.txt --no-cache-dir
  #        "

  #    - name: Run E2E tests in Docker
  #      run: |
  #        docker compose exec -T producer bash -c "
  #          KAFKA_BROKERS=kafka:29092 \
  #          MINIO_ENDPOINT=http://minio:9000 \
  #          PYTHONPATH=/app/ingestion:/app/processing:/app/query:/app \
  #          pytest /app/tests/e2e/ \
  #            -v \
  #            --tb=short \
  #            --timeout=300
  #        "

  #    - name: Collect logs on failure
  #      if: failure()
  #      run: |
  #        docker compose logs > e2e-test-logs.txt

  #    - name: Upload logs
  #      if: failure()
  #      uses: actions/upload-artifact@v4
  #      with:
  #        name: e2e-test-logs
  #        path: e2e-test-logs.txt

  #    - name: Cleanup
  #      if: always()
  #      run: |
  #        docker compose down -v

  # ============================================
  # DOCKER COMPOSE VALIDATION
  # ============================================
  compose-validation:
    name: Docker Compose Validation
    runs-on: ubuntu-latest
    needs: build-images
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Validate docker compose file
        run: |
          docker compose config > /dev/null

      - name: Start services
        run: |
          docker compose up -d
          sleep 30

      - name: Run health checks
        run: |
          chmod +x scripts/health_check.sh
          bash scripts/health_check.sh

      - name: Check Kafka topic creation
        run: |
          docker compose exec -T kafka /opt/kafka/bin/kafka-topics.sh \
          --bootstrap-server localhost:9092 \
          --create \
          --topic iot-events \
          --partitions 3 \
          --replication-factor 1 \
          --if-not-exists

      - name: Verify producer metrics endpoint
        run: |
          curl -f http://localhost:8082/metrics || echo "Producer not ready yet, retrying..."
          sleep 10
          curl -f http://localhost:8082/metrics

      - name: Verify Prometheus endpoint
        run: |
          curl -f http://localhost:9090/-/healthy

      - name: Verify Grafana endpoint
        run: |
          curl -f http://localhost:3000/api/health

      - name: Collect logs on failure
        if: failure()
        run: |
          docker compose logs > docker-logs.txt

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docker compose-logs
          path: docker-logs.txt

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v

  # ============================================
  # SECURITY SCANNING
  # ============================================
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
        continue-on-error: true

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"
        continue-on-error: true

  # ============================================
  # NOTIFY SUCCESS
  # ============================================
  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, compose-validation]
    if: success()

    steps:
      - name: Send success notification
        run: |
          echo "âœ… All CI/CD checks passed!"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
